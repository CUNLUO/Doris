Introduction

This is Doris V5, it contains doris that can process a stack of sentinel_1 images, as well as all the already familiar functionality of Doris 4. 

This is a beta version, intended to be tested internally at TU Delft, as well as by a limited number of known beta-testers. From beta-testers we request feedback which will help us to develop the Doris 5 stable version. For your information, we are currently working on the further development of the software regarding processing flow (input control, distributed processing, logging, error handling). Therefore, your feedback on the algorithmic part of the implementation will be most useful.

The new Doris version consists of 2 parts:
-       The doris_core directory cantaining the Doris core code, which is similar to the original Doris code and is written in C. This code is mainly used to create individual interferograms based on different steps.
-       The doris_stack directory containing scripts written in python. These scripts automate the processing of a single master stack of sentinel 1 images. The scripts manage the processing of the bursts of a sentinel 1 image, contain algorithms specific to processing sentinel 1 images and support parallelisation of the processing of the bursts. The functionality of these scripts can be further extended to support more sensors and modes.

Installation


In this manual we assume that you have installed the Doris core. To use the doris_stack python scripts you will need to install the following packages:
-       numpy, scipy (for calculations)
-       matplotlib (visualization)
-       gdal, gdal-dev, shapely, fiona, pyproj (GIS)
-       xml, re (data readers)
-       shutil, collections, os, sys, copy, datetime, time, math (general packages)

To install these packages we advise to use anaconda. This package comes with de Spyder IDE, which can be used to do some editing of the code. When you want a better insight in the overall project structure we recommend you install PyCharm as an additional IDE.

After installation of the python packages you have to make a link to the doris_core, cpxfiddle and snaphu executable. You can do
so by executing the following steps:

# move to the install directory
cd install
# run the python script
python init_cfg.py

If you don't have the three executables, you will have to compile these. Guidelines to do so can be found
at:
http://doris.tudelft.nl/

----------------------------------------------------------------------------------------------
Datastacks

After installing the software you can create your first doris datastack. To do so you have to prepare the following:
- Download the needed Sentinel-1 SAR images and place the .zip files in one directory (you can have sub-directories)
- Create a folder to store the orbit files and download the needed orbit files from:
    https://qc.sentinel1.eo.esa.int/
    s1-a / s1-b and precise and restituted can be mixed. Only use restituted orbits with recent SAR data (< 14 days ago)
- Create a folder where you can store intermediate DEM results. Data will be downloaded automatically, so you only have
    to create the folder itself.
- Create a .shp file with your area of interest. You can use different software packages, but ArcGIS and QGIS (free) are
    the most convenient for this purpose.
- Finally, create the folder where you want to process your datastack. Be aware that to process your data you will need
    at least 100 GB of free space on your disc.

Now you can run the code to create a new datastack:

# move to the prepare_stack directory
cd prepare_stack
# run the python script
python prepare_datastack.py

This code will ask you to define the different folders you created before. Then it generates a structure which is ready
to process your datastack. It will ask whether you want to run your code in parallel. Generally, this is recommended as
it speeds up your processing speed. Note that either the number of cores and your RAM can be limiting (one process will
use about 4GB of RAM).

You can enter the folder to find, the newly created DEM, your .shp file, configuration files (inputfiles) and the stack.
Further there is doris_stack.xml. This is a doris_input.xml file where all configuration settings for your datastack are stored. 
This file is created in the folder where you will process your datastack. So, if you want to change this configuration 
afterwards, you can make some changes there.

Finally, there is the doris_stack.sh file to run the actual processing.

------------------------------------------------------------------------------------------------
Processing

To start the processing of your datastack you will have to set some variables in doris_input.sh file in your datastack folder.
On the end of the last line in this file you will find:

-s yyyy-mm-dd -e yyyy-mm-dd -m yyyy-mm-dd

These variables are used to define:
- s > start date of your datastack. What is the first image (in time) you want to process?
- e > end date of your datastack. What is the last image (in time) you want to process?
- m > master data of your datastack. Which image will be used as the master of your stack. Other images will be resampled
        to the geometry of this master image.
Note that the start and end date are not necessarily but can also be chosen years back or in the far future to capture
all images. The master dataset should be part off your dataset and should be between the start and end date.

Now you made the changes you can start and start your processing by the following command:
qsub run.sh

The terminal will give information on the progress of the processing. Expect a total run time of 10 hours for one
interferogram using one core. From this it should scale almost linearly if your hard disc is fast enough... Upscaling to
4 or 8 cores with 16 or 32 GB RAM works generally fine on a normal desktop.

